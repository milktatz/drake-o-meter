<script>
/* ğŸ”¥ YOUR FIREBASE CONFIG (unchanged) ğŸ”¥ */
firebase.initializeApp({
  apiKey: "PASTE_HERE",
  authDomain: "PASTE_HERE",
  databaseURL: "PASTE_HERE",
  projectId: "PASTE_HERE",
  appId: "PASTE_HERE"
});

const auth = firebase.auth();
const db = firebase.database();

const trustEl = document.getElementById("trust");
const distrustEl = document.getElementById("distrust");
const totalEl = document.getElementById("total");
const fill = document.getElementById("fill");
const status = document.getElementById("status");

const trustBtn = document.getElementById("trustBtn");
const distrustBtn = document.getElementById("distrustBtn");

trustBtn.disabled = true;
distrustBtn.disabled = true;
status.textContent = "Connectingâ€¦";

/* âœ… AUTH FIX */
auth.onAuthStateChanged(user => {
  if (!user) return;

  status.textContent = "Ready to vote";
  trustBtn.disabled = false;
  distrustBtn.disabled = false;

  const totalsRef = db.ref("totals");

  /* âœ… Initialize totals if missing */
  totalsRef.once("value").then(snap => {
    if (!snap.exists()) {
      totalsRef.set({ trust: 0, distrust: 0 });
    }
  });

  /* âœ… Live updates */
  totalsRef.on("value", snap => {
    const data = snap.val() || { trust: 0, distrust: 0 };
    const total = data.trust + data.distrust;

    trustEl.textContent = data.trust;
    distrustEl.textContent = data.distrust;
    totalEl.textContent = total;

    const pct = total ? Math.round((data.trust / total) * 100) : 50;
    fill.style.width = pct + "%";
    fill.textContent = pct + "%";
  });

  /* âœ… SAFE VOTE FUNCTION */
  window.vote = function(type) {
    const uid = user.uid;

    trustBtn.disabled = true;
    distrustBtn.disabled = true;

    const updates = {};
    updates[`votes/${uid}/lastVote`] = firebase.database.ServerValue.TIMESTAMP;
    updates[`totals/${type}`] = firebase.database.ServerValue.increment(1);

    db.ref().update(updates)
      .then(() => {
        status.textContent = "Vote recorded";
        setTimeout(() => {
          trustBtn.disabled = false;
          distrustBtn.disabled = false;
        }, 3000);
      })
      .catch(() => {
        status.textContent = "You can vote again in 5 minutes";
        setTimeout(() => {
          trustBtn.disabled = false;
          distrustBtn.disabled = false;
        }, 3000);
      });
  };
});

/* Start anonymous auth */
auth.signInAnonymously();

/* Button hooks */
trustBtn.onclick = () => vote("trust");
distrustBtn.onclick = () => vote("distrust");
</script>
